+++
title = "Using Psalm and PhpStorm for realtime static analysis"
date = "2019-09-23T04:53:01+0000"
slug = "using-psalm-and-phpstorm-for-realtime-static-analysis"
type = "post"
+++

<p>Building on the <a href="/2019/08/setting-up-phpstorm-as-a-new-developer/">static analysis of Phan</a>, I’ve also recently started using <a href="https://psalm.dev/">Psalm, a PHP static analyzer</a> from Vimeo’s engineering team. What I particularly love about Psalm is its realtime analysis and integration within PhpStorm. Instead of needing to run a report after any changes, Psalm can highlight issues as they happen with my source code open.</p>
<div class="wp-block-image"><figure class="aligncenter is-resized"><img alt="" class="wp-image-5258" decoding="async" fetchpriority="high" height="168" sizes="(max-width: 366px) 100vw, 366px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-7.46.22-PM.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-7.46.22-PM.png 896w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-7.46.22-PM-300x139.png 300w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-7.46.22-PM-768x355.png 768w" width="366"/></figure></div>
<p>While Psalm includes the necessary language server to integrate with PhpStorm, a plugin is needed to make the connection. I’m using the <a href="https://plugins.jetbrains.com/plugin/10209-lsp-support/">LSP Support plugin by Guillaume Tâche</a>. Here’s what I did to get everything setup, and some lessons I learned along the way.</p>
<h4 class="wp-block-heading"><a aria-hidden="true" class="aal_anchor" href="#getting-set-up" id="getting-set-up"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Getting Set Up</h4>
<p>First, Install Psalm via composer:</p>
<pre class="EnlighterJSRAW" data-enlighter-group="" data-enlighter-highlight="" data-enlighter-language="shell" data-enlighter-linenumbers="false" data-enlighter-lineoffset="" data-enlighter-theme="" data-enlighter-title="">composer require --dev vimeo/psalm</pre>
<p>Then setup a psalm.xml configuration file. Psalm provides 8 levels of strictness, 1 being the most strict and 3 being the default. I’m using level 4.</p>
<pre class="EnlighterJSRAW" data-enlighter-group="" data-enlighter-highlight="" data-enlighter-language="shell" data-enlighter-linenumbers="false" data-enlighter-lineoffset="" data-enlighter-theme="" data-enlighter-title="">./vendor/bin/psalm --init [source_directory=src] [config_level=3]</pre>
<p>Next, I have a few of my own helper functions, so I added stubs to those functions inside the psalm.xml. I also use New Relic, and JetBrains helpfully provides a repo that contains <a href="https://github.com/JetBrains/phpstorm-stubs">pre-defined stubs for numerous libraries</a>.</p>
<pre class="EnlighterJSRAW" data-enlighter-group="" data-enlighter-highlight="" data-enlighter-language="xml" data-enlighter-linenumbers="false" data-enlighter-lineoffset="" data-enlighter-theme="" data-enlighter-title="">    &lt;stubs&gt;
        &lt;file name="../phpstorm-stubs/newrelic/newrelic.php"/&gt;
        &lt;file name="../phpstorm-stubs/funnel-cake/funnel-cake.php"/&gt;
    &lt;/stubs&gt;</pre>
<p>At this point Psalm is installed and configured – now let’s get some static analysis goodness from it!</p>
<h4 class="wp-block-heading"><a aria-hidden="true" class="aal_anchor" href="#using-psalm" id="using-psalm"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Using Psalm</h4>
<p>To see Psalm’s analysis in your console, you’ll only need to run <code>psalm</code> from the same directory as your <code>psalm.xml</code>. For some reason for me, I was getting corrupt caches (I think from running psalm while the language server is setup, which i’ll explain below), so I run from the command line with:</p>
<pre class="EnlighterJSRAW" data-enlighter-group="" data-enlighter-highlight="" data-enlighter-language="shell" data-enlighter-linenumbers="false" data-enlighter-lineoffset="" data-enlighter-theme="" data-enlighter-title="">psalm --no-progress --no-cache</pre>
<p>I’ve setup an External Tool in PhpStorm to run the above, which will show its output from inside of PhpStorm. I’ve actually setup a short script to better format Psalm’s output. PhpStorm needs absolute file paths, and can then link directly to the issue. Save the following script as <code>run_psalm.sh</code> in the root directory of your project:</p>
<pre class="EnlighterJSRAW" data-enlighter-group="" data-enlighter-highlight="" data-enlighter-language="shell" data-enlighter-linenumbers="false" data-enlighter-lineoffset="" data-enlighter-theme="" data-enlighter-title="">psalm --no-progress --no-cache &gt; psalm.out

cat psalm.out | sed G | sed -E 's|(.*) - ([a-zA-Z0-9 _\./\-]+:[[:digit:]]+)|'"$(pwd)"'/\2\
\1|g' | perl -pi -0 -w -e 's/\n\n/\n/g'

rm psalm.out</pre>
<p>Then, in PhpStorm, open up External Tools in the Preferences window:</p>
<div class="wp-block-image"><figure class="aligncenter is-resized"><img alt="" class="wp-image-5267" decoding="async" height="120" sizes="(max-width: 306px) 100vw, 306px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-10.56.58-PM.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-10.56.58-PM.png 504w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-10.56.58-PM-300x118.png 300w" width="306"/><figcaption>Preferences → Tools → External Tools</figcaption></figure></div>
<p>Then, add a new external tool and fill in the details to run the above script:</p>
<div class="wp-block-image"><figure class="aligncenter"><img alt="" class="wp-image-5268" decoding="async" height="830" sizes="(max-width: 1024px) 100vw, 1024px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.02.34-PM-1024x830.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.02.34-PM-1024x830.png 1024w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.02.34-PM-300x243.png 300w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.02.34-PM-768x623.png 768w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.02.34-PM.png 1436w" width="1024"/><figcaption>The Output filter will allow PhpStorm to auto-link issues from Psalm’s output.</figcaption></figure></div>
<p>I’ve also setup an External Tool for Phan, as I’ve described before, so my Tools → External Tools menu shows both Phan and Psalm options now:</p>
<div class="wp-block-image"><figure class="aligncenter is-resized"><img alt="" class="wp-image-5269" decoding="async" height="179" loading="lazy" sizes="auto, (max-width: 323px) 100vw, 323px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.04.21-PM.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.04.21-PM.png 806w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.04.21-PM-300x167.png 300w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.04.21-PM-768x427.png 768w" width="323"/></figure></div>
<p>But this is only the first integration – the next one is what’s got me most excited about Psalm – full IDE integration for realtime highlighting of issues.</p>
<h4 class="wp-block-heading"><a aria-hidden="true" class="aal_anchor" href="#language-server-plugin" id="language-server-plugin"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Language Server Plugin</h4>
<p>To get realtime analysis, open up PhpStorm’s plugin marketplace and search for “LSP Support” and you’ll find the plugin by gtache.</p>
<div class="wp-block-image"><figure class="aligncenter is-resized"><a href="https://plugins.jetbrains.com/plugin/10209-lsp-support/" rel="noreferrer noopener" target="_blank"><img alt="" class="wp-image-5271" decoding="async" height="220" loading="lazy" sizes="auto, (max-width: 366px) 100vw, 366px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.07.40-PM.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.07.40-PM.png 770w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.07.40-PM-300x180.png 300w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.07.40-PM-768x461.png 768w" width="366"/></a></figure></div>
<p>After installing the plugin and restarting PhpStorm, you’ll see a new menu in the Languages &amp; Frameworks section of preference window. Open the Server Definitions section.</p>
<div class="wp-block-image"><figure class="aligncenter"><img alt="" class="wp-image-5273" decoding="async" height="252" loading="lazy" sizes="auto, (max-width: 300px) 100vw, 300px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.10.49-PM-300x252.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.10.49-PM-300x252.png 300w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.10.49-PM.png 520w" width="300"/><figcaption>Preferences → Languages &amp; Frameworks → Language Server Protocol → Server Definitions</figcaption></figure></div>
<p>Set the first drop down it <code>Executable</code>, and set the <code>Extension</code> to <code>php</code>. For the <code>path</code>, set it to the path of your <code>php</code> executable. I’m running MAMP, I’ve set my <code>path</code> to <code>/Applications/MAMP/bin/php/php7.3.8/bin/php</code>. Last, set the <code>args</code> to <code>vendor/bin/psalm-language-server</code>.</p>
<p>Your configuration should look something like this when you’re done:</p>
<div class="wp-block-image"><figure class="aligncenter"><img alt="" class="wp-image-5274" decoding="async" height="86" loading="lazy" sizes="auto, (max-width: 1024px) 100vw, 1024px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.15.26-PM-1024x86.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.15.26-PM-1024x86.png 1024w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.15.26-PM-300x25.png 300w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.15.26-PM-768x64.png 768w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.15.26-PM.png 1980w" width="1024"/></figure></div>
<p>Restart PhpStorm, open a php file, and if everything goes well you should see the language server icon show the start up success and see the green status icon in the footer. <img alt="" class="wp-image-5275" decoding="async" height="44" loading="lazy" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.16.55-PM.png" style="width: 46px;" width="46"/></p>
<p>Now you should be seeing live Psalm feedback inside of PhpStorm!</p>
<h4 class="wp-block-heading"><a aria-hidden="true" class="aal_anchor" href="#its-not-perfect" id="its-not-perfect"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>It’s Not Perfect</h4>
<p>There’s a few odd things I’ve noticed when using the language server, here’s a few:</p>
<ol class="wp-block-list"><li>It doesn’t seem to start until I’ve edited a file. After opening a file, nothing will highlight until i’ve typed at least 1 character into the editor, but then everything will pop in.</li><li>Sometimes it’s slow. I think it re-analyzes after every keystroke, and I wish the LSP Plugin would be a bit gentler here</li><li>I’ve received occasional crashes of the LSP Support plugin. It’s rare enough that it’s not a huge problem, but is a bit of an inconvenience.</li><li>The plugin overwrites the Quick Documentation mouse click with its own popover. I’ve set option+click to open the Quick Documentation window, but instead it was opening the LSP information.</li></ol>
<div class="wp-block-image"><figure class="aligncenter is-resized"><img alt="" class="wp-image-5279" decoding="async" height="211" loading="lazy" sizes="auto, (max-width: 440px) 100vw, 440px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.27.12-PM-1024x494.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.27.12-PM-1024x494.png 1024w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.27.12-PM-300x145.png 300w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.27.12-PM-768x370.png 768w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.27.12-PM.png 1054w" width="440"/><figcaption>Here’s the default Quick Documentation that I want….</figcaption></figure></div>
<div class="wp-block-image"><figure class="aligncenter is-resized"><img alt="" class="wp-image-5280" decoding="async" height="176" loading="lazy" sizes="auto, (max-width: 352px) 100vw, 352px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.28.38-PM.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.28.38-PM.png 696w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.28.38-PM-300x150.png 300w" width="352"/><figcaption>But here’s the Quick Documentation override in the LSP Plugin</figcaption></figure></div>
<h4 class="wp-block-heading"><a aria-hidden="true" class="aal_anchor" href="#customizing-the-lsp-plugin" id="customizing-the-lsp-plugin"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Customizing the LSP Plugin</h4>
<p>Because of the crashes I ran into, and the fact that I really liked the older Quick Documentation more than the LSP documentation, I decided to try and customize the plugin just a bit to see if I could change that.</p>
<p>You can find the full source of the LSP Plugin on GitHub: <a href="https://github.com/gtache/intellij-lsp">https://github.com/gtache/intellij-lsp</a>. And I’ve forked the code to remove the Quick Documentation override: <a href="https://github.com/adamwulf/intellij-lsp/tree/feature/remove-quickdoc">https://github.com/adamwulf/intellij-lsp/tree/feature/remove-quickdoc</a>. I’ve also fixed some of the crashes I’ve run into, but not all of them.</p>
<p>To build from my fork:</p>
<pre class="EnlighterJSRAW" data-enlighter-group="" data-enlighter-highlight="" data-enlighter-language="shell" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-theme="" data-enlighter-title="">git clone git@github.com:adamwulf/intellij-lsp.git
git checkout feature/remove-quickdoc
./gradlew buildPlugin</pre>
<p>That will generate a <code>build/distributions/LSP Support.zip</code> file that you can install into PhpStorm. To install, open the Plugins section, click the gear, and choose Install From Disk, select the .zip file, and away you go.</p>
<div class="wp-block-image"><figure class="aligncenter is-resized"><img alt="" class="wp-image-5281" decoding="async" height="106" loading="lazy" sizes="auto, (max-width: 333px) 100vw, 333px" src="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.35.42-PM.png" srcset="/wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.35.42-PM.png 852w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.35.42-PM-300x96.png 300w, /wp-content/uploads/2019/09/Screen-Shot-2019-09-22-at-11.35.42-PM-768x247.png 768w" width="333"/><figcaption>Choose build/distributions/LSP Support.zip to install the custom build.</figcaption></figure></div>
<h4 class="wp-block-heading"><a aria-hidden="true" class="aal_anchor" href="#conclusion" id="conclusion"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Conclusion</h4>
<p>After learning more about Psalm and its PhpStorm intonations, I now have:</p>
<ol class="wp-block-list"><li>Realtime analysis for any option files using the LSP Support plugin</li><li>Full project analysis using the External Tools menu option</li><li>A custom LSP plugin for ultimate nerd customization</li></ol>
<h4 class="wp-block-heading"><a aria-hidden="true" class="aal_anchor" href="#links" id="links"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Links</h4>
<ul class="wp-block-list"><li>Psalm static analyzer: <a href="https://psalm.dev/">https://psalm.dev</a></li><li>PhpStorm: <a href="https://www.jetbrains.com/phpstorm/">https://www.jetbrains.com/phpstorm/</a></li><li>LSP Support PhpStorm plugin: <a href="https://github.com/gtache/intellij-lsp">https://github.com/gtache/intellij-lsp</a></li><li>My fork of the plugin: <a href="https://github.com/adamwulf/intellij-lsp">https://github.com/adamwulf/intellij-lsp</a></li><li>Pre-defined code stubs: <a href="https://github.com/JetBrains/phpstorm-stubs">https://github.com/JetBrains/phpstorm-stubs</a></li></ul>