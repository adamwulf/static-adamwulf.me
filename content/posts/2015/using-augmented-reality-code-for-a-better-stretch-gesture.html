+++
title = "Using Augmented Reality Code for a Better Stretch Gesture"
date = "2015-02-18T09:19:41+0000"
slug = "using-augmented-reality-code-for-a-better-stretch-gesture"
type = "post"
+++

<p><a href="https://getlooseleaf.com/">Loose Leaf</a> is more about photos and imports than it is about drawing or sketching, and I wanted to make sure it was easy not only to <a href="http://blog.getlooseleaf.com/post/109315792079/the-making-of-loose-leafs-killer-feature">cut and create new scraps</a>, but also to manipulate and duplicate existing scraps. To make a copy of a photo or scrap, I thought through numerous gesture options, menus, long press popups, buttons, and more, and in the end I settled on a simple pull-it-apart-gesture.</p>
<p>So how’d it turn out? Here’s what it looks like to duplicate any photo scrap in Loose Leaf, just pull it apart into two identical pieces.</p>
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-9d6595d7 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-video"><video controls="" loop="" src="/wp-content/uploads/2015/02/1179614070580658176.mp4"></video></figure>
</div>
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow"></div>
</div>
<p>It’s a simple gesture to pull a photo into two copies. The stretch animation as you pull makes it obvious what’s happening, and then — snap! — It’s two copies!</p>
<p>The difficult piece of this gesture isn’t the copy itself, it’s the stretch animation as you pull the image apart. For a number of reasons, I needed to do this without additional OpenGL rendering, I needed to keep the code solidly in the normal UIKit stuff. To make it work, I borrowed some technology that’s fairly common in Augmented Reality apps: it’s called <a href="http://en.wikipedia.org/wiki/Homography_(computer_vision)">homography</a>.</p>
<p>The short description is that any convex quadrilateral can appear to be any other convex quadrilateral by just rotating and translating it- It basically lets me turn any four sided shape into any other four sided shape. Perfect! scraps, even non-rectangle one’s cut by scissors, are still modeled as simple rectangle UIViews. As I stretch, I can transform that rectangle into a parallelogram for that stretched effect.</p>
<p>Here’s the simple test application I used to fine-tune the animation with the above strategy:</p>
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-9d6595d7 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-video"><video controls="" loop="" src="/wp-content/uploads/2015/02/1179622108163166208.mp4"></video></figure>
</div>
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow"></div>
</div>
<p>The algorithm visible above goes through the following steps:</p>
<ol class="wp-block-list">
<li>create a 4 sided quadrilateral from the four touch points on the scrap</li>
<li>as the fingers move, create a 2nd quadrilateral from the new locations of those same touches</li>
<li>compute the homography between those two quadrilaterals to find the transform between them</li>
<li>apply that transform to the scrap itself</li>
</ol>
<p>Note that I’m not trying to calculate the transform from the UIView’s bounds to its new parallelogram – instead i’m transforming the quad of finger positions to thew new quad of finger positions, then using <em>that</em> transform on the view.</p>
<p>The red lines in the above image is the quadrilateral between the touch points. The green line is an “average” quadrilateral, which averages the red quad into a parallelogram. You can see the stretch is very dramatic, and it causes a problem if the touch points form ever form a concave instead of convex polygon. You can see an example of what goes wrong below:</p>
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-9d6595d7 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-video"><video controls="" loop="" src="/wp-content/uploads/2015/02/1179668228285321216.mp4"></video></figure>
</div>
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow"></div>
</div>
<p>But if I use the average quad instead, and treat those points as transforms between parallelograms, then the same gesture gives smoother results:</p>
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-9d6595d7 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-video"><video controls="" loop="" src="/wp-content/uploads/2015/02/1179627430470987776.mp4"></video></figure>
</div>
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow"></div>
</div>
<p>My last experiment for the stretch gesture was how to keep the orientation of the image as it stretched. I thought about trying to maintain the “up”ness of the image regardless of the stretch vs. having the gesture also rotate the image during the stretch. You can see what I mean with the two videos below.</p>
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-9d6595d7 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-video"><video controls="" loop="" src="/wp-content/uploads/2015/02/1179630221427630080.mp4"></video></figure>
</div>
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-video"><video controls="" loop="" src="/wp-content/uploads/2015/02/1179630435035217920-1.mp4"></video></figure>
</div>
</div>
<p>In the end, I decided to rotate the image during the gesture, and not try to maintain “up” orientation. It gave a cool effect, especially when stretching, but felt just a bit off since it also caused the fingers to slide more over the image.</p>
<p>To try it for yourself, download <a href="https://itunes.apple.com/us/app/loose-leaf/id625659452?mt=8&amp;uo=4&amp;at=10lNUI&amp;ct=blog">Loose Leaf</a> on the app store.</p>
<p>You can also find <a href="https://github.com/adamwulf/MMStretchGestureRecognizers">all of the code on GitHub</a> for each one of the versions talked about here, and be sure to check out the rest of <a href="https://getlooseleaf.com/opensource/">Loose Leaf’s open source contributions</a> as well.</p>