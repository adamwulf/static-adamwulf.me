+++
title = "Embedded command line tool in Mac App Store app"
date = "2023-04-30T04:23:09+0000"
slug = "embedded-command-line-tool-in-mac-app-store-app"
type = "post"
+++

<p>I’ve started work on a command line tool for <a data-id="https://developerduck.app/" data-type="URL" href="https://developerduck.app/">Developer Duck</a>, an AI powered developer helper tool. The app can act as a rubber-duck-style chat assistant to help you with your code, and can also automate some of the simple and tedious tasks: adding/removing documentation comments, adding explanation comments, even code completion. I’d like to offer this functionality through the command line for integration into the rest of a developer’s workflow too.</p>
<p>As I soon found out, shipping a command line tool to the Mac App Store is not entirely straightforward. The problem: shipping to the Mac App Store requires a sandboxed app, and all bundled executables must be sandboxed as well. This ends up being slightly more complicated than just adding a Command Line Tool target to my Xcode project.</p>
<p>Thankfully, <a href="https://developer.apple.com/documentation/xcode/embedding-a-helper-tool-in-a-sandboxed-app">Apple provides documentation</a> for exactly this task. And for the majority of the work, this documentation was perfect. Unfortunately, after following those instructions my command line program crashed immediately with a <code>Trace/BPT trap: 5</code> error.</p>
<p>My first real clue was Console showing the following line:</p>
<pre class="EnlighterJSRAW" data-enlighter-group="" data-enlighter-highlight="" data-enlighter-language="generic" data-enlighter-linenumbers="false" data-enlighter-lineoffset="" data-enlighter-theme="" data-enlighter-title="">ASI found [libsystem_secinit.dylib] (sensitive) 'Unable to get bundle identifier for container id com.the.product.bundle.identifier: Unable to get bundle identifier because code signature information has no Info.Plist.'</pre>
<p>It seems that somehow the system is expecting this command line tool to have an Info.plist, which doesn’t entirely make sense to me. It’s not a real bundle, it’s just a single executable file. I’m must be missing something. Next, I found this helpful <a href="https://github.com/Timac/Mac-App-Store-Embedding-a-Command-Line-tool-using-paths-as-arguments">git repo</a> which pointed to the related <a href="https://blog.timac.org/2021/0516-mac-app-store-embedding-a-command-line-tool-using-paths-as-arguments/">blog post</a> by <a href="https://mastodon.social/@timac">Alexandre Colucci</a>. The clue was this step in his blog post:</p>
<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p>To be properly code signed, the <code>Info.plist</code> needs to be embedded into the binary. This can be done using the <code>CREATE_INFOPLIST_SECTION_IN_BINARY</code> setting</p>
<cite><a href="https://blog.timac.org/2021/0516-mac-app-store-embedding-a-command-line-tool-using-paths-as-arguments/">https://blog.timac.org/2021/0516-mac-app-store-embedding-a-command-line-tool-using-paths-as-arguments/</a></cite></blockquote>
<p>Ah! This must be it – the message in Console was complaining about not finding an Info.plist, and so if we can embed that plist into the executable file, maybe that’ll do the trick? Odd, because there’s still not an Info.plist file for this target, but maybe it’ll make an empty section in the executable? I added this build setting, but unfortunately still no dice. I get the same crash. I even set an <code>INFOPLIST_FILE</code> build setting on the target and created an empty Info.plist, but that didn’t seem to work either.</p>
<p>Then I decided to filter the Build Settings in Xcode for “plist” and found the promising <code>GENERATE_INFOPLIST_FILE</code> setting. I updated my <code>.xcconfig</code> with both of these:</p>
<pre class="EnlighterJSRAW" data-enlighter-group="" data-enlighter-highlight="" data-enlighter-language="generic" data-enlighter-linenumbers="false" data-enlighter-lineoffset="" data-enlighter-theme="" data-enlighter-title="">CREATE_INFOPLIST_SECTION_IN_BINARY = YES
GENERATE_INFOPLIST_FILE = YES</pre>
<p>Success! Now, Xcode will generate whatever Info.plist it needs and embed it into the binary. This allows it to be found when running the command line executable, and everything works great.</p>
<p>My next adventure will be to read and write files that were passed as arguments to the tool. <a href="https://blog.timac.org/2021/0516-mac-app-store-embedding-a-command-line-tool-using-paths-as-arguments/">The same post</a> by Alexandre very helpfully covers this case too!</p>