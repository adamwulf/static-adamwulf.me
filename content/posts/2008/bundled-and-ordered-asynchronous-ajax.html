+++
title = "Bundled and Ordered AJAX"
date = "2008-09-21T22:05:31+0000"
slug = "bundled-and-ordered-asynchronous-ajax"
type = "post"
+++

<div class="related">Related to: <a href="/tutorials/bundled-synchronous-ajax-with-jquery/">Bundled and Ordered Asynchronous AJAX in jQuery Tutorial</a><br/>
Also posted on the <a href="http://blog.listotron.com/2008/09/21/bundled-and-ordered-asynchronous-ajax/">Listotron Blog</a></div>
<h3><a aria-hidden="true" class="aal_anchor" href="#the-problem" id="the-problem"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>The Problem</h3>
<p>Imagine for a moment that you’re building a web application based nearly 100% percent on AJAX. And imagine that you’ll likely need to send bursts of  multiple AJAX requests to your server, and you also need all of these requests to be processed <em>in order</em> when they hit your server. You want a near continuous AJAX connection – every action, every edit, every keystroke the user makes – all of these need to be sent to your server for processing. You are building <a href="http://www.listotron.com/">Listotron</a>.</p>
<p>This is exactly the problem I’ve created for myself by working on the <a href="http://www.listotron.com/">Listotron</a> project with <a href="http://www.keepthewebweird.com/">Buck</a>. <a href="http://www.listotron.com/">Listotron</a> is [will be] a simple web app that lets users easily create and edit lists and collaborate on them in real time. Simple put, it’ll be a web based <a href="http://www.omnigroup.com/applications/omnioutliner/">OmniOutliner</a> with a much smaller feature set and multi-user realtime editing. I’m particularly excited to use it as a research playground for optimizing web-apps. (As we build, we’ll be sharing our ideas, plans, code, prototypes, and much more – so check out the <a href="http://blog.listotron.com/">Listotron blog</a> for more).</p>
<p>Since we’re designing <a href="http://www.listotron.com/">Listotron</a> to be a 100% AJAX based application, every edit the user makes will need to be AJAX’d to the server. What’s more, we want users to be able collaboratively edit the same list at the same time – <a href="http://docs.google.com/">Google Spreadsheets</a> style. This means that every edit, every tab, every indent, <em>everything</em> needs to be AJAX’d quickly and efficiently to our server so we can update any collaborators that might also be working on the list.</p>
<p>Most importantly, all of the edits need to happen <em>in order</em>, since most edits to the list will depend on previous edits to the list.</p>
<p>My goals for speed are to make the real-time editing even faster than Google’s collaborative spreadsheet editing. A large part of the perceived speed of collaboration is the frequency of AJAX calls (the more calls per second the faster the app can update collaborators) – so I’ll need both an incredibly streamlined server-side and an incredibly optimized AJAX front-end in JavaScript. This article will talk about the JavaScript strategy.</p>
<h4><a aria-hidden="true" class="aal_anchor" href="#asynchronous-ajax" id="asynchronous-ajax"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Asynchronous AJAX</h4>
<p>The problem with relying on plain ole’ asynchronous AJAX is that it’s, well, asynchronous. We’re not guaranteed that all of our AJAX calls will be received by the sever in the correct order, and we’re certainly not guaranteed that we’ll receive the responses in the correct order.  <a href="/wp-content/uploads/2008/08/picture-2.png"><img alt="" class="alignnone size-full wp-image-865" decoding="async" fetchpriority="high" height="147" sizes="(max-width: 376px) 100vw, 376px" src="/wp-content/uploads/2008/08/picture-2.png" srcset="/wp-content/uploads/2008/08/picture-2.png 376w, /wp-content/uploads/2008/08/picture-2-300x117.png 300w" title="Asynchronous AJAX" width="376"/></a></p>
<p>Imagine sending off 4+ edits to the sever, only to find out in the last response that the 2nd request failed. What if edits 3 and 4 relied on edit 2? How do I roll back the UI? How do I maintain data integrity on the server? on the client? It’d be hell to build, hell to debug, and hell to maintain. No thanks!</p>
<h4><a aria-hidden="true" class="aal_anchor" href="#synchronous-ajax" id="synchronous-ajax"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Synchronous AJAX</h4>
<p><span style="color: #333333; font-style: normal; line-height: 23px;">Since I need to send all my AJAX requests to the server in order, why not just use synchronous ajax calls? Problem solved, right? Unfortunately, it’s not that simple – from the <a href="http://yuiblog.com/blog/2006/04/04/synchronous-v-asynchronous/">YUI blog</a>:</span></p>
<blockquote><p>XMLHttpRequest can operate synchronously or asynchronously. Many people prefer to use it synchronously. When used this way, the JavaScript engine is blocked until the interaction with the server is complete… Temporal complexity is abstracted away, leaving a very familiar and comfortable programming pattern.</p></blockquote>
<p>So far so good, but here’s the zinger (emphasis added)…</p>
<blockquote><p>Because the JavaScript engine is blocked until the request completes, the browser will be frozen.<strong> The user cannot cancel the request, cannot click away, cannot go to another tab</strong>. This is extremely bad behavior.</p></blockquote>
<p>That’s very bad news indeed. Synchronous AJAX ends up looking something like this:</p>
<p><a href="/wp-content/uploads/2008/08/picture-11.png"><img alt="" class="alignnone size-full wp-image-863" decoding="async" height="190" sizes="(max-width: 367px) 100vw, 367px" src="/wp-content/uploads/2008/08/picture-11.png" srcset="/wp-content/uploads/2008/08/picture-11.png 367w, /wp-content/uploads/2008/08/picture-11-300x155.png 300w" title="Synchronous AJAX" width="367"/></a></p>
<p>Clearly this is not the way to go. It’s simply not acceptable to freeze the <em>entire browser</em> – (even in <a href="http://www.google.com/chrome">Chrome</a>‘s case: the entire tab) – for every single tiny edit. A different approach needs to be made.</p>
<h3><a aria-hidden="true" class="aal_anchor" href="#the-solution" id="the-solution"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><strong>The Solution</strong></h3>
<p><strong></strong>The solution we’ll be using with <a href="http://www.listotron.com/">Listotron</a> is to manually enforce synchronization into what would otherwise be asynchronous AJAX calls. The idea is this: after an AJAX request is made, queue up any other requests that need to be made until a response comes back – then send a single bundled AJAX request that contains all of the requests currently in the queue. The server decodes this bundled AJAX call, processes each request, and sends back a bundled response. All this ends up looking something like:</p>
<p><a href="/wp-content/uploads/2008/08/picture-3.png"><img alt="" class="alignnone size-full wp-image-868" decoding="async" height="251" sizes="(max-width: 416px) 100vw, 416px" src="/wp-content/uploads/2008/08/picture-3.png" srcset="/wp-content/uploads/2008/08/picture-3.png 416w, /wp-content/uploads/2008/08/picture-3-300x181.png 300w" title="Bundled AJAX with description" width="416"/></a></p>
<p>Since we need to maintain the call-order of our AJAX calls, we can queue them up in-order and then send off multiple requests to our server in one go. The benefits are: (1) fewer http connections hitting the server, and (2) the order of the AJAX calls is maintained, (3) and UI is still very responsive. <em>And</em>, since the server sees multiple edits at the same time, further optimization can be done that would otherwise be impossible. For instance, the server receives 2 commands in a bundle: an indent command followed by an outdent command. The net result to the list is to do nothing!</p>
<p>This optimization comes at a price, of course, and it’s that the server needs some custom code to handle these bundled AJAX requests, so this solution isn’t as easy as dropping in a new JavaScript framework or function.</p>
<h3><a aria-hidden="true" class="aal_anchor" href="#bringing-it-to-life" id="bringing-it-to-life"><svg aria-hidden="true" class="aal_svg" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Bringing It To Life</h3>
<p>I’ve set up a <a href="/tutorials/bundled-synchronous-ajax-with-jquery/">basic demo and tutorial</a> that bundles up asynchronous AJAX calls to maintain their order. I’ve implemented everything as a jQuery plugin with a lightweight PHP/MySQL server-side. Check it out <a href="/tutorials/bundled-synchronous-ajax-with-jquery/">here</a>.</p>
<p>(This post is a <a href="http://blog.listotron.com/2008/09/21/bundled-and-ordered-asynchronous-ajax/">cross-posted</a> on the <a href="http://blog.listotron.com/">Listotron blog</a>)</p>