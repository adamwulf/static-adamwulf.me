+++
title = "Managing Plugins in WPMU"
date = "2008-10-04T01:06:30+0000"
slug = "managing-plugins-in-wpmu"
type = "post"
+++

<p>John Resig <a href="http://ejohn.org/blog/javascript-micro-templating/">released a small script</a> that letâ€™s you easily do some â€œquick-and-dirtyâ€ templating on the client side. I love the idea, but Iâ€™m less than a fan of the implementation, but Iâ€™ll get to that in a minute. First the love:Â This small script lets you essentially copy and paste some HTML and hot swap out new data as itâ€™s [presumably] ajaxâ€™d in, and that is incredibly handy. You even get fancy template style syntax like â€œ&lt;% for(..) %&gt;â€ Â So how is this done?</p>
<p>Templates are be defined in script blocks (notice the type attribute):</p>
<p>[code lang=â€™htmlâ€™]<br/>
<br/>
[/code]</p>
<p>And to use the template is simply:</p>
<p>[code lang=â€™javascriptâ€™]<br/>
var results = document.getElementById(â€œresultsâ€);<br/>
results.innerHTML = tmpl(â€œitem_tmplâ€, dataObject);<br/>
[/code]</p>
<p>Itâ€™s easy, to be sure, and the results are slick. Iâ€™ve found myself needing to do this sort of copy/paste of DOM structure many many many times when building <a href="https://www.jotlet.net/">Jotlet</a>. So why donâ€™t I like it? Well letâ€™s take a look at the magic that makes this possible:</p>
<pre><span>// Simple JavaScript Templating</span>
<span>// John Resig - http://ejohn.org/ - MIT Licensed</span>
<span>(</span><span>function</span><span>(</span><span>)</span><span>{</span>
Â Â <span>var</span>Â cache =Â <span>{</span><span>}</span>;
Â Â 
Â Â <span>this</span>.<span>tmpl</span>Â =Â <span>function</span>Â tmpl<span>(</span>str, data<span>)</span><span>{</span>
Â  Â Â <span>// Figure out if we're getting a template, or if we need to</span>
Â  Â Â <span>// load the template - and be sure to cache the result.</span>
Â  Â Â <span>var</span>Â fn = !<span>/W/</span>.<span>test</span><span>(</span>str<span>)</span>Â ?
Â  Â  Â  cache<span>[</span>str<span>]</span>Â = cache<span>[</span>str<span>]</span>Â ||
Â  Â  Â  Â  tmpl<span>(</span>document.<span>getElementById</span><span>(</span>str<span>)</span>.<span>innerHTML</span><span>)</span>Â :
Â  Â  Â Â 
Â  Â  Â Â <span>// Generate a reusable function that will serve as a template</span>
Â  Â  Â Â <span>// generator (and which will be cached).</span>
Â  Â  Â Â <span>new</span>Â <span>Function</span><span>(</span><span>"obj"</span>,
Â  Â  Â  Â Â <span>"var p=[],print=function(){p.push.apply(p,arguments);};"</span>Â +
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span>// Introduce the data as local variables using with(){}</span>
Â  Â  Â  Â Â <span>"with(obj){p.push('"</span>Â +
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span>// Convert the template into pure JavaScript</span>
Â  Â  Â  Â  str
Â  Â  Â  Â  Â  .<span>replace</span><span>(</span><span>/<span>[</span>rtn<span>]</span>/g</span>,Â <span>" "</span><span>)</span>
Â  Â  Â  Â  Â  .<span>split</span><span>(</span><span>"&lt;%"</span><span>)</span>.<span>join</span><span>(</span><span>"<span>t</span>"</span><span>)</span>
Â  Â  Â  Â  Â  .<span>replace</span><span>(</span>/<span>(</span><span>(</span>^|%&gt;<span>)</span><span>[</span>^t<span>]</span>*<span>)</span><span>'/g, "$1<span>r</span>")
Â  Â  Â  Â  Â  .replace(/<span>t</span>=(.*?)%&gt;/g, "'</span>,$<span>1</span>,<span>'")
Â  Â  Â  Â  Â  .split("<span>t</span>").join("'</span><span>)</span>;<span>")
Â  Â  Â  Â  Â  .split("</span>%&gt;<span>").join("</span>p.<span>push</span><span>(</span><span>'")
Â  Â  Â  Â  Â  .split("<span>r</span>").join("'</span><span>")
Â  Â  Â  + "</span><span>');}return p.join('</span><span>');");
Â  Â Â 
Â  Â  // Provide some basic currying to the user
Â  Â  return data ? fn( data ) : fn;
Â  };
})();</span></pre>
<p>So whatâ€™s going on here? The template string input is being converted to raw JavaScript that, when executed, will return HTML. The â€œnew Function()â€ basically wraps that JS in an closure to be eval()â€™d if/when thereâ€™s data. If data was passed in to templ(), then the Function() is executed immediately and the result HTML is returned. if no data is passed in, then the Function is returned.</p>
<p>Iâ€™ll be honest, when I see String data being turned into code I shudder. I subscribe to the â€œdonâ€™t make it any more complicated than it needs to beâ€ paradigm, and storing code as data or vice versa does exactly that. It adds more complication for IMO no benefit. Also â€“ thereâ€™s the security risk. If you never mix code and data, then if your data becomesÂ compromisedÂ or corrupted, you can still be 100% sure that your code is still safe. But if you mix code and data, and your data gets fudged, then your code is equally screwed.</p>
<p>Itâ€™s just good practice: data is data and code is code.</p>
<p>Luckily, one of <a href="http://ejohn.org/blog/javascript-micro-templating/#comment-318940">Resigâ€™s commenters,Â </a><a href="http://irae.pro.br/en/" rel="external nofollow">IraÃª</a><a href="http://ejohn.org/blog/javascript-micro-templating/#comment-318940">,</a>Â proposes in my view a much better (and safer) solution:</p>
<pre>markup={};
markup.user = function() {
html='
&lt;dl&gt;
&lt;dt&gt;'+this.name+'&lt;/dt&gt;
&lt;dd&gt;'+this.about+'&lt;/dd&gt;
&lt;/dl&gt;';
return html;
}</pre>
<p>And to use it:</p>
<pre>$('#output').html(markup.user.apply(data));</pre>
<p>This way is so much cleaner! The only Strings in this solution is the data itself, and the â€˜codeâ€™ of the template isâ€¦ JavaScript itself! Less confusing. Less code to write. Less security risk. Whatâ€™s not to like?</p>
<p>Â </p>
<p>Last Thoughts:</p>
<p>I mentioned we had a use for this sort of thing when we built <a href="http://www.jotlet.net/">Jotlet</a>. So what did we do? We built classes for each of our UI elements. Code looked something like:</p>
<pre>var taskRow = new TaskRow();
taskRow.setTask(taskObj);
document.body.appendChild(taskRow.getDOM());</pre>
<p>The DOM for that task could either be cached, or used for another task with a call to:</p>
<pre>taskRow.setTask(otherTaskObj);</pre>
<p>Itâ€™s a far different solution (and heavier weight) than whatâ€™s being talked about here. Iâ€™ll save details for another post ğŸ™‚</p>